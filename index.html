<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XMR Web Miner</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .engine-banner { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid var(--accent); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 0 20px rgba(110, 231, 255, 0.2); }
    .engine-banner .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin-bottom: 0.5rem; }
    .engine-banner .engine-name { font-size: 1.5rem; font-weight: bold; color: var(--accent); text-shadow: 0 0 10px rgba(110, 231, 255, 0.5); }
    .engine-banner.wasm .engine-name { color: #6ee7ff; }
    .engine-banner.js .engine-name { color: #ffaa00; }
    .status-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .stat-box { background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; text-align: center; }
    .stat-box .value { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
    .stat-box .label { font-size: 0.8rem; color: var(--muted); }
    .log-container { background: rgba(0,0,0,0.5); border-radius: 8px; padding: 1rem; margin-top: 1rem; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; }
    .log-entry { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .log-entry:last-child { border-bottom: none; }
    .log-entry.info { color: #6ee7ff; }
    .log-entry.success { color: #00ff88; }
    .log-entry.warning { color: #ffaa00; }
    .log-entry.error { color: #ff4444; }
  </style>
</head>
<body>
  <div id="warningModal" class="modal-overlay">
    <div class="modal-content">
      <h2>⚠️ Mining Consent</h2>
      <p>This site uses your CPU to mine Monero (XMR) cryptocurrency.</p>
      <p><strong>DISCLAIMER:</strong> All mining proceeds go to the site owner.</p>
      <p>By clicking "Start Mining", you consent to resource usage.</p>
      <button id="agreeBtn" class="btn primary">Start Mining</button>
    </div>
  </div>

  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header"><h2>Miner Status</h2></div>
      <div class="sidebar-content">
        <div class="stat-item"><div class="label">Engine</div><div class="value" id="sidebarAlgo">Detecting...</div></div>
        <div class="stat-item"><div class="label">Hashrate</div><div class="value" id="sidebarHashrate">0 H/s</div></div>
        <div class="stat-item"><div class="label">Total Hashes</div><div class="value" id="sidebarTotalHashes">0</div></div>
        <div class="stat-item"><div class="label">Accepted</div><div class="value" id="sidebarAccepted" style="color: #00ff88;">0</div></div>
        <div class="stat-item"><div class="label">Workers</div><div class="value" id="sidebarThreads">0</div></div>
        <div class="stat-item"><div class="label">Uptime</div><div class="value" id="sidebarUptime">0:00</div></div>
        <hr class="divider">
        <div class="info-section"><p style="font-size: 0.8rem; color: var(--muted);">Pool: SupportXMR<br>⚡ Real Mining Active</p></div>
      </div>
    </aside>

    <main class="main-content">
      <div class="wrap">
        <div class="engine-banner" id="engineBanner">
          <div class="label">Mining Engine</div>
          <div class="engine-name" id="engineName">Detecting...</div>
        </div>

        <header>
          <h1>Monero Web Miner</h1>
          <p class="sub" id="engineSub">Initializing...</p>
        </header>

        <section class="card">
          <div class="status-row">
            <div>
              <button id="startBtn" class="btn primary" disabled>Loading...</button>
              <button id="stopBtn" class="btn" disabled>Stop</button>
            </div>
            <div class="stat">
               <div class="k">Status</div>
               <div class="v" id="status">Loading...</div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-box"><div class="value" id="hashrate">0</div><div class="label">H/s</div></div>
            <div class="stat-box"><div class="value" id="totalHashes">0</div><div class="label">Total Hashes</div></div>
            <div class="stat-box"><div class="value" id="acceptedShares">0</div><div class="label">Accepted</div></div>
            <div class="stat-box"><div class="value" id="threads">0</div><div class="label">Workers</div></div>
          </div>
          
          <div class="progress-bar">
             <div class="bar-fill" id="barFill"></div>
             <div class="bar-text" id="barText">Ready to mine</div>
          </div>
          
          <div class="log-container" id="logContainer">
            <div class="log-entry info">Initializing miner...</div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const WALLET = '47ocfRVLCp71ZtNvdrxtAR85VDbNdmUMph5mNWfRf3z2FuRhPFJVm7cReXjM1i1sZmE4vsLWd32BvNSUhP5NQjwmR1zGTuL';
    
    // Proxy URL
    const wsProtocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
    let hostname = location.hostname;
    let proxyUrl = '';

    if (hostname.includes('-8080') && hostname.includes('github.dev')) {
        hostname = hostname.replace('-8080', '-8888');
        proxyUrl = wsProtocol + hostname + '/proxy';
    } else {
        proxyUrl = wsProtocol + hostname + ':8888/proxy';
    }
    
    const $ = id => document.getElementById(id);
    let workers = [];
    let startTime = null, uptimeInterval = null;
    
    function log(msg, type = 'info') {
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
      $('logContainer').appendChild(entry);
      $('logContainer').scrollTop = $('logContainer').scrollHeight;
      while ($('logContainer').children.length > 50) $('logContainer').removeChild($('logContainer').firstChild);
    }
    
    function fmtNum(n) { return n.toLocaleString(undefined, { maximumFractionDigits: 2 }); }
    
    function fmtUptime(ms) {
      const s = Math.floor(ms / 1000), h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), r = s % 60;
      return h > 0 ? h + ':' + String(m).padStart(2, '0') + ':' + String(r).padStart(2, '0') : m + ':' + String(r).padStart(2, '0');
    }
    
    function updateUptime() { if (startTime) $('sidebarUptime').textContent = fmtUptime(Date.now() - startTime); }
    
    function detectEngine() {
      $('engineName').textContent = 'CryptoNight JS/WASM';
      $('sidebarAlgo').textContent = 'CryptoNight';
      $('engineBanner').classList.add('wasm');
      $('engineSub').textContent = 'Real Mining Engine';
    }
    
    function startMining() {
      const numWorkers = navigator.hardwareConcurrency || 4;
      log('Starting ' + numWorkers + ' workers...', 'info');
      log('Proxy: ' + proxyUrl, 'info');
      
      startTime = Date.now();
      uptimeInterval = setInterval(updateUptime, 1000);
      
      $('startBtn').disabled = true; 
      $('startBtn').textContent = 'Mining...'; 
      $('stopBtn').disabled = false;
      $('status').textContent = 'Starting...';
      $('status').style.color = '#ffaa00';
      
      // Create workers
      for (let i = 0; i < numWorkers; i++) {
        const worker = new Worker('worker.js');
        workers.push(worker);
        
        worker.onmessage = function(e) {
          const msg = e.data;
          
          if (msg.type === 'status') {
            $('status').textContent = msg.message;
            if (msg.message.includes('Mining')) $('status').style.color = '#00ff88';
            log(msg.message, 'info');
          }
          else if (msg.type === 'engine') {
            $('engineName').textContent = msg.value;
            $('sidebarAlgo').textContent = msg.value;
          }
          else if (msg.type === 'progress') {
            const hashrate = msg.hashRate || 0;
            $('hashrate').textContent = fmtNum(hashrate);
            $('sidebarHashrate').textContent = fmtNum(hashrate) + ' H/s';
            $('totalHashes').textContent = fmtNum(msg.totalHashes || 0);
            $('sidebarTotalHashes').textContent = fmtNum(msg.totalHashes || 0);
            $('barFill').style.width = ((msg.totalHashes % 1000) / 10) + '%';
            $('barText').textContent = 'Mining: ' + fmtNum(hashrate) + ' H/s';
          }
          else if (msg.type === 'accepted') {
            $('acceptedShares').textContent = msg.count;
            $('sidebarAccepted').textContent = msg.count;
            log('Share Accepted! Total: ' + msg.count, 'success');
          }
          else if (msg.type === 'rejected') {
            log('Share Rejected: ' + (msg.error || 'Unknown'), 'error');
          }
          else if (msg.type === 'error') {
            log('Error: ' + msg.message, 'error');
          }
        };
        
        worker.postMessage({
          type: 'start',
          pool: proxyUrl,
          wallet: WALLET,
          intensity: 10
        });
      }
      
      $('threads').textContent = numWorkers;
      $('sidebarThreads').textContent = numWorkers;
    }
    
    function stopMining() {
      log('Stopping...', 'warning');
      workers.forEach(w => { w.postMessage({ type: 'stop' }); w.terminate(); });
      workers = [];
      if (uptimeInterval) clearInterval(uptimeInterval);
      $('startBtn').disabled = false; 
      $('startBtn').textContent = 'Start Mining'; 
      $('stopBtn').disabled = true;
      $('status').textContent = 'Stopped'; 
      $('status').style.color = '#ff4444';
    }
    
    function init() { 
        detectEngine();
        $('startBtn').disabled = false; 
        $('startBtn').textContent = 'Start Mining'; 
        $('status').textContent = 'Ready'; 
        log('CryptoNight miner ready!', 'success'); 
        log('Proxy: ' + proxyUrl, 'info');
    }
    
    $('agreeBtn').addEventListener('click', () => { $('warningModal').style.display = 'none'; startMining(); });
    $('startBtn').addEventListener('click', startMining);
    $('stopBtn').addEventListener('click', stopMining);
    window.addEventListener('load', init);
  </script>
</body>
</html>
